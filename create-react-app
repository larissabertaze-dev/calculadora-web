import { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

export default function CalculadoraReact() {
  const [display, setDisplay] = useState("");
  const [history, setHistory] = useState([]);
  const [dark, setDark] = useState(false);

  function append(value) {
    setDisplay((prev) => prev + value);
  }

  function clearDisplay() {
    setDisplay("");
  }

  function deleteLast() {
    setDisplay((prev) => prev.slice(0, -1));
  }

  function calculate() {
    try {
      const expression = display.replace("%", "/100");
      const result = eval(expression);

      setHistory((prev) => [`${display} = ${result}`, ...prev]);
      setDisplay(String(result));
    } catch {
      setDisplay("Erro");
    }
  }

  // âŒ¨ï¸ Suporte ao teclado
  useEffect(() => {
    function handleKey(e) {
      if (!isNaN(e.key) || "+-*/.%".includes(e.key)) {
        append(e.key);
      }

      if (e.key === "Enter") calculate();
      if (e.key === "Backspace") deleteLast();
      if (e.key === "Escape") clearDisplay();
    }

    window.addEventListener("keydown", handleKey);
    return () => window.removeEventListener("keydown", handleKey);
  });

  const buttons = [
    "C",
    "âŒ«",
    "%",
    "/",
    "7",
    "8",
    "9",
    "*",
    "4",
    "5",
    "6",
    "-",
    "1",
    "2",
    "3",
    "+",
    "0",
    ".",
    "=",
  ];

  function handleClick(btn) {
    if (btn === "C") return clearDisplay();
    if (btn === "âŒ«") return deleteLast();
    if (btn === "=") return calculate();
    append(btn);
  }

  return (
    <div
      className={`min-h-screen flex items-center justify-center p-4 transition-colors ${
        dark ? "bg-zinc-900" : "bg-gray-100"
      }`}
    >
      <Card className="w-full max-w-sm shadow-2xl rounded-2xl">
        <CardContent className="p-4 space-y-3">
          {/* Topo */}
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold">Calculadora</h2>
            <Button
              variant="outline"
              onClick={() => setDark(!dark)}
            >
              {dark ? "â˜€ï¸" : "ğŸŒ™"}
            </Button>
          </div>

          {/* HistÃ³rico */}
          <div className="h-20 overflow-y-auto text-sm text-gray-500 border rounded-xl p-2">
            {history.map((item, i) => (
              <p key={i}>{item}</p>
            ))}
          </div>

          {/* Visor */}
          <input
            value={display}
            disabled
            className="w-full h-14 text-right text-2xl border rounded-xl p-2"
          />

          {/* BotÃµes */}
          <div className="grid grid-cols-4 gap-2">
            {buttons.map((btn, i) => (
              <Button
                key={i}
                onClick={() => handleClick(btn)}
                className={`h-12 text-lg rounded-xl ${
                  btn === "="
                    ? "col-span-2"
                    : btn === "0"
                    ? "col-span-2"
                    : ""
                }`}
              >
                {btn}
              </Button>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
